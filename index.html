<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreshChain - Inventory Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .wallet-box { background: #e8f0fe; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; border: 1px solid #d2e3fc; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        .role-selector { text-align: center; margin-bottom: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; }
        select { padding: 10px; font-size: 16px; border-radius: 5px; width: 200px; }
        .panel { display: none; border-top: 2px solid #eee; margin-top: 20px; padding-top: 20px; }
        .panel.active { display: block; animation: fadeIn 0.5s; }
        .form-group { margin-bottom: 15px; }
        input { padding: 10px; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; margin-top: 5px; }
        label { font-weight: bold; color: #555; }
        #statusMessage { margin-top: 20px; padding: 15px; border-radius: 5px; display: none; text-align: center; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        #productResult { background: #333; color: #0f0; padding: 15px; border-radius: 5px; margin-top: 15px; font-family: monospace; white-space: pre-wrap; display: none; }
        
        /* QR Code Alanƒ± ƒ∞√ßin Stil */
        #qrcode {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>üçÖ FreshChain Inventory Management System </h1>

    <div class="wallet-box">
        <p id="walletAddress">Wallet not Connected.</p>
        <button onclick="connectWallet()">ü¶ä Connect MetaMask </button>
		<button class="secondary" onclick="enableGuestMode()">üë§ Guest Mode (Read-Only)</button>
    </div>

    <div class="role-selector">
        <label>Choose the role for process</label><br>
        <select id="roleSelect" onchange="switchPanel()">
            <option value="none">-- Options --</option>
            <option value="adminPanel">Admin</option>
            <option value="farmerPanel">Producer (Farmer)</option>
            <option value="transporterPanel">Transporter</option>
			<option value="distributorPanel">Distributor</option>
            <option value="retailerPanel">Retailer</option>
            <option value="customerPanel">Customer</option>
        </select>
    </div>

    <div id="statusMessage"></div>

    <div id="adminPanel" class="panel">
        <h2>üëÆ Admin Management</h2>
		<div id="adminLoginBox" style="background:#f8d7da;border:1px solid #f5c6cb;padding:12px;border-radius:8px;margin-bottom:15px;">
    <b>Admin Login (for instructor)</b>
    <p style="margin:6px 0 10px 0; font-size: 13px; color:#721c24;">
        This panel is protected with a fixed password for evaluation. Credentials are auto-filled.
    </p>

    <div class="form-group">
        <label>Admin Password:</label>
        <input type="password" id="adminPassword" value="bc123" placeholder="bc123">
    </div>

    <button onclick="adminLogin()">‚úÖ Login as Admin</button>
</div>

        <div class="form-group">
            <label> Enter Wallet Adress (0x...):</label>
            <input type="text" id="actorAddress" placeholder="0x123...">
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="registerActor('registerFarmer')">Make Producer</button>
            <button onclick="registerActor('registerTransporter')">Make Transporter</button>
            <button onclick="registerActor('registerDistributor')">Make Distributor</button>
            <button onclick="registerActor('registerRetailer')">Make Retailer</button>
        </div>
    </div>

    <div id="farmerPanel" class="panel">
        <h2>üë©‚Äçüåæ Producer: Create Product</h2>
        <div class="form-group">
            <label>Batch ID:</label>
            <input type="number" id="batchIdCreate">
        </div>
        <div class="form-group">
            <label>Product Name:</label>
            <input type="text" id="productName">
        </div>
        <div class="form-group">
            <label>Amount:</label>
            <input type="number" id="quantity">
        </div>
        <button onclick="createBatch()">Create Batch</button>
        <hr>
        <h3>Transfer Proccess</h3>
        <p>For transfer the product to Transporter:</p>
        <div class="form-group">
            <label>Batch ID to be transferred:</label>
            <input type="number" id="transferBatchId">
        </div>
        <div class="form-group">
            <label>Transporter Adress:</label>
            <input type="text" id="transferNewOwner">
        </div>
        <button class="secondary" onclick="transferOwnership()">Transfer</button>
    </div>

    <div id="transporterPanel" class="panel">
        <h2>üöö Transporter: Add Sensor Data</h2>
        <div class="form-group">
            <label>Batch ID:</label>
            <input type="number" id="sensorBatchId">
        </div>
        <div class="form-group">
            <label>Temperature (¬∞C) [Between -10 and 40]:</label>
            <input type="number" id="sensorTemp">
        </div>
        <div class="form-group">
            <label>Humidity (%) [Between 0 and 40]:</label>
            <input type="number" id="sensorHumidity">
        </div>
        <div class="form-group">
            <label>Location (Town/Storage):</label>
            <input type="text" id="sensorLocation">
        </div>
        <button onclick="addSensorData()">Add Sensor Data</button>

		<hr>
<h3>Transfer Process</h3>
<p>After recording sensor data, transfer the batch to Distributor:</p>

<div class="form-group">
  <label>Batch ID to be transferred:</label>
  <input type="number" id="transporterTransferBatchId">
</div>

<div class="form-group">
  <label>Distributor Address (0x...):</label>
  <input type="text" id="transporterTransferNewOwner" placeholder="0x123...">
</div>

<button class="secondary" onclick="transferOwnershipFromTransporter()">Transfer to Distributor</button>

    </div>

	<div id="distributorPanel" class="panel">
  <h2>üè¨ Distributor: Ownership Transfer</h2>
  <p>Distributor, batch kendisindeyken √ºr√ºn√º Retailer'a transfer eder.</p>

  <div class="form-group">
    <label>Batch ID:</label>
    <input type="number" id="distributorTransferBatchId">
  </div>

  <div class="form-group">
    <label>Retailer Address (0x...):</label>
    <input type="text" id="distributorTransferNewOwner" placeholder="0x123...">
  </div>

  <button class="secondary" onclick="transferOwnershipFromDistributor()">Transfer to Retailer</button>
</div>


    <div id="retailerPanel" class="panel">
        <h2>üè™ Retailer: Product Acceptance</h2>
        <div class="form-group">
            <label>Batch ID:</label>
            <input type="number" id="retailerBatchId">
        </div>
        <div class="form-group">
            <label>Control Result:</label>
            <select id="inspectionResult" style="width: 100%;">
                <option value="true">‚úÖ Passed (Confirm)</option>
                <option value="false">‚ùå Failed (Rejected)</option>
            </select>
        </div>
        <button onclick="markAsArrived()">Mark as Arrived</button>
    </div>

    <div id="customerPanel" class="panel">
        <h2>üîç Customer: Product Inquiry</h2>
        <div class="form-group">
            <label>Batch ID:</label>
            <input type="number" id="queryBatchId">
        </div>
        <button onclick="getBatchHistory()">Inquire & Generate QR</button>
        
        <div id="qrcode"></div>
        <p style="text-align:center; font-size:12px; color:#666;">Scan this code to see details on phone</p>

        <div id="productResult"></div>
    </div>

</div>

<script>
    // ============================================================
    // 1. AYARLAR
    // ============================================================
    const contractAddress = "0xC21C0C43E3BbE2F600C59137C157EE70D65967F6"; 

    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_batchId",
				"type": "uint256"
			},
			{
				"internalType": "int256",
				"name": "_temperature",
				"type": "int256"
			},
			{
				"internalType": "int256",
				"name": "_humidity",
				"type": "int256"
			},
			{
				"internalType": "string",
				"name": "_location",
				"type": "string"
			}
		],
		"name": "addSensorData",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "retailer",
				"type": "address"
			}
		],
		"name": "BatchArrived",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "farmer",
				"type": "address"
			}
		],
		"name": "BatchCreated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_batchId",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "_productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_quantity",
				"type": "uint256"
			}
		],
		"name": "createBatch",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_batchId",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "_passedInspection",
				"type": "bool"
			}
		],
		"name": "markAsArrived",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_distributor",
				"type": "address"
			}
		],
		"name": "registerDistributor",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_farmer",
				"type": "address"
			}
		],
		"name": "registerFarmer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_retailer",
				"type": "address"
			}
		],
		"name": "registerRetailer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_transporter",
				"type": "address"
			}
		],
		"name": "registerTransporter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "int256",
				"name": "temperature",
				"type": "int256"
			},
			{
				"indexed": false,
				"internalType": "int256",
				"name": "humidity",
				"type": "int256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "location",
				"type": "string"
			}
		],
		"name": "SensorDataAdded",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_batchId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "_newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "batches",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "currentOwner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "farmer",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "isArrived",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "batchExists",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "distributors",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "farmers",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_batchId",
				"type": "uint256"
			}
		],
		"name": "getBatchHistory",
		"outputs": [
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "farmer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "currentOwner",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "isArrived",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			},
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "int256",
						"name": "temperature",
						"type": "int256"
					},
					{
						"internalType": "int256",
						"name": "humidity",
						"type": "int256"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "address",
						"name": "recordedBy",
						"type": "address"
					}
				],
				"internalType": "struct FreshChain.SensorLog[]",
				"name": "logs",
				"type": "tuple[]"
			},
			{
				"internalType": "address[]",
				"name": "owners",
				"type": "address[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "retailers",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "transporters",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    let provider, signer, contract;

let isGuestMode = false;
let adminUnlocked = false;
const sepoliaRpcUrl = "https://eth-sepolia.g.alchemy.com/v2/7wZVQuGXZ_Uo833XR3fmR";

function getBatchIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get("batchId");
}

async function handleQrScanRedirect() {
    const batchId = getBatchIdFromUrl();
    if (!batchId) return false;

    // M√º≈üteri panelini a√ß
    document.getElementById("roleSelect").value = "customerPanel";
    switchPanel();

    // batchId input alanƒ±na yaz
    document.getElementById("queryBatchId").value = batchId;

    // Guest mode a√ß
    await enableGuestMode();

    // Veri √ßek
    await getBatchHistory();

    return true;
}


// -------------------- WALLET --------------------
async function connectWallet() {
    if (typeof window.ethereum === 'undefined') {
        alert("L√ºtfen tarayƒ±cƒ±nƒ±za MetaMask y√ºkleyin!");
        return;
    }

    try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();

        const address = await signer.getAddress();
        document.getElementById("walletAddress").innerText = "‚úÖ Connected: " + address;
        document.getElementById("walletAddress").style.color = "green";

        contract = new ethers.Contract(contractAddress, contractABI, signer);

        isGuestMode = false; // guest'ten √ßƒ±k
        showStatus("C√ºzdan baƒülandƒ± ve kontrat hazƒ±r!", "success");
    } catch (error) {
        console.error(error);
        showStatus("Baƒülantƒ± hatasƒ±: " + error.message, "error");
    }
}

// -------------------- GUEST MODE (READ ONLY) --------------------
async function enableGuestMode() {
    try {
        isGuestMode = true;
        adminUnlocked = false;

        provider = new ethers.providers.JsonRpcProvider(sepoliaRpcUrl);
        contract = new ethers.Contract(contractAddress, contractABI, provider);

        document.getElementById("walletAddress").innerText = "üë§ Guest Mode (Read-Only) - MetaMask not required";
        document.getElementById("walletAddress").style.color = "#004085";

        showStatus("Guest mode enabled. You can view batch history without wallet.", "info");

        document.getElementById("roleSelect").value = "customerPanel";
        switchPanel();
    } catch (err) {
        console.error(err);
        showStatus("Guest mode error: " + (err.message || err), "error");
    }
}

// -------------------- ADMIN LOGIN (UI GATE) --------------------
function adminLogin() {
    const pass = document.getElementById("adminPassword").value;
    const FIXED_PASSWORD = "bc123"; // input ile aynƒ±

    if (pass === FIXED_PASSWORD) {
        adminUnlocked = true;
        document.getElementById("adminLoginBox").style.display = "none";
        showStatus("Admin unlocked. (MetaMask required for transactions)", "success");
    } else {
        adminUnlocked = false;
        showStatus("Wrong admin password.", "error");
    }
}

// -------------------- PANEL SWITCH --------------------
function switchPanel() {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    const selected = document.getElementById("roleSelect").value;
    if (selected === "none") return;

    // Admin panel: password gate
    if (selected === "adminPanel") {
        document.getElementById("adminPanel").classList.add('active');
        document.getElementById("adminLoginBox").style.display = adminUnlocked ? "none" : "block";
        return;
    }

    document.getElementById(selected).classList.add('active');
}

// -------------------- STATUS --------------------
function showStatus(msg, type) {
    const el = document.getElementById("statusMessage");
    el.innerText = msg;
    el.className = type;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 5000);
}

// -------------------- HELPERS --------------------
function requireWriteAccess() {
    if (isGuestMode) {
        alert("Guest mode is read-only. Please connect MetaMask for write actions.");
        return false;
    }
    if (!contract) {
        alert("√ñnce c√ºzdanƒ± baƒüla!");
        return false;
    }
    return true;
}

// -------------------- ADMIN ACTIONS --------------------
async function registerActor(methodName) {
    if (!adminUnlocked) return alert("Admin panel locked. Please login with the fixed admin password.");
    if (!requireWriteAccess()) return;

    const address = document.getElementById("actorAddress").value;

    try {
        showStatus("ƒ∞≈ülem onaylanƒ±yor...", "info");
        const tx = await contract[methodName](address);
        showStatus("Madencilik bekleniyor...", "info");
        await tx.wait();
        showStatus("Successful.", "success");
    } catch (err) {
        showStatus("Error: " + (err.reason || err.message), "error");
    }
}

// -------------------- PRODUCER --------------------
async function createBatch() {
    if (!requireWriteAccess()) return;

    const id = document.getElementById("batchIdCreate").value;
    const name = document.getElementById("productName").value;
    const qty = document.getElementById("quantity").value;

    try {
        showStatus("√úr√ºn olu≈üturuluyor...", "info");
        const tx = await contract.createBatch(id, name, qty);
        await tx.wait();
        showStatus("Successful! Batch #" + id + " created.", "success");
    } catch (err) {
        showStatus("Hata: " + (err.reason || err.message), "error");
    }
}

async function transferOwnership() {
    if (!requireWriteAccess()) return;

    const id = document.getElementById("transferBatchId").value;
    const newOwner = document.getElementById("transferNewOwner").value;

    try {
        showStatus("Transfer ba≈ülatƒ±ldƒ±...", "info");
        const tx = await contract.transferOwnership(id, newOwner);
        await tx.wait();
        showStatus("Successful! Transferred.", "success");
    } catch (err) {
        showStatus("Hata: " + (err.reason || err.message), "error");
    }
}

// -------------------- TRANSPORTER --------------------
async function addSensorData() {
    if (!requireWriteAccess()) return;

    const id = document.getElementById("sensorBatchId").value;
    const temp = document.getElementById("sensorTemp").value;
    const hum = document.getElementById("sensorHumidity").value;
    const loc = document.getElementById("sensorLocation").value;

    try {
        showStatus("Veri kaydediliyor...", "info");
        const tx = await contract.addSensorData(id, temp, hum, loc);
        await tx.wait();
        showStatus("Successful! Sensor data added.", "success");
    } catch (err) {
        showStatus("Hata: " + (err.reason || err.message), "error");
    }
}

async function transferOwnershipFromTransporter() {
  if (!requireWriteAccess()) return;

  const id = document.getElementById("transporterTransferBatchId").value;
  const newOwner = document.getElementById("transporterTransferNewOwner").value;

  try {
    showStatus("Transporter transfer ba≈ülatƒ±ldƒ±...", "info");
    const tx = await contract.transferOwnership(id, newOwner);
    await tx.wait();
    showStatus("Successful! Batch transferred to Distributor.", "success");
  } catch (err) {
    showStatus("Hata: " + (err.reason || err.message), "error");
  }
}


// -------------------- DISTRIBUTOR --------------------
async function transferOwnershipFromDistributor() {
  if (!requireWriteAccess()) return;

  const id = document.getElementById("distributorTransferBatchId").value;
  const newOwner = document.getElementById("distributorTransferNewOwner").value;

  try {
    showStatus("Distributor transfer ba≈ülatƒ±ldƒ±...", "info");
    const tx = await contract.transferOwnership(id, newOwner);
    await tx.wait();
    showStatus("Successful! Batch transferred to Retailer.", "success");
  } catch (err) {
    showStatus("Hata: " + (err.reason || err.message), "error");
  }
}


// -------------------- RETAILER --------------------
async function markAsArrived() {
    if (!requireWriteAccess()) return;

    const id = document.getElementById("retailerBatchId").value;
    const result = document.getElementById("inspectionResult").value === "true";

    try {
        showStatus("Onay g√∂nderiliyor...", "info");
        const tx = await contract.markAsArrived(id, result);
        await tx.wait();
        showStatus("Successful! Product on the market now.", "success");
    } catch (err) {
        showStatus("Hata: " + (err.reason || err.message), "error");
    }
}

// -------------------- CUSTOMER (READ ONLY OK) --------------------
async function getBatchHistory() {
    if (!contract) return alert("Please connect MetaMask OR enable Guest Mode.");

    const id = document.getElementById("queryBatchId").value;
    const resultBox = document.getElementById("productResult");
    const qrContainer = document.getElementById("qrcode");

    qrContainer.innerHTML = "";
    resultBox.style.display = 'none';

    try {
        showStatus("Loading the Data...", "info");
        const data = await contract.getBatchHistory(id);

        let html = `üì¶ <b>Product Details (Batch #${id})</b>\n`;
        html += `----------------------------------\n`;
        html += `üè∑Ô∏è Product Name: ${data[0]}\n`;
        html += `‚öñÔ∏è Amount: ${data[1]}\n`;
        html += `üë®‚Äçüåæ Producer: ${data[2]}\n`;
        html += `üë§ Current Holder: ${data[3]}\n`;
        html += `üèÅ Market Arrival: ${data[4] ? "ARRIVED" : "ON THE WAY"}\n`;
        html += `üìã Quality Control: ${data[5] ? "‚úÖ PASSED" : "‚ùå FAILED/PENDING"}\n`;

        html += `\nüå°Ô∏è <b>SENSOR DETAILS</b>\n`;
        if (data[6].length === 0) html += "No records yet.\n";
        data[6].forEach((log, index) => {
            const date = new Date(log.timestamp * 1000).toLocaleString();
            html += `${index + 1}. [${date}] ${log.location} -> ${log.temperature}¬∞C, %${log.humidity} Humidity\n`;
        });

        html += `\nü§ù <b>TRANSFER HISTORY</b>\n`;
        data[7].forEach((owner, index) => {
            html += `${index + 1}. ${owner}\n`;
        });

        resultBox.style.display = 'block';
        resultBox.innerHTML = html;
    
		const baseUrl = window.location.origin + window.location.pathname;
const qrData = `${baseUrl}?batchId=${id}`;

new QRCode(qrContainer, { 
    text: qrData, 
    width: 128, 
    height: 128, 
    correctLevel: QRCode.CorrectLevel.H 
});


        showStatus("Successful", "success");
    } catch (err) {
        console.error(err);
        resultBox.style.display = 'none';
        showStatus("Hata: √úr√ºn bulunamadƒ± veya bir sorun olu≈ütu.", "error");
    }
}

document.addEventListener("DOMContentLoaded", async () => {
    const redirected = await handleQrScanRedirect();

    if (!redirected) {
        // QR ile gelmemi≈üse normal √ßalƒ±≈üma
        document.getElementById("walletAddress").innerText =
            "Wallet not Connected.";
    }
});


</script>

</body>
</html>
